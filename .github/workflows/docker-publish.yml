name: Publish Docker Image

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to publish (e.g., test, v1.0.0, latest)'
        required: true
        default: 'latest'
      platforms:
        description: 'Platforms to build for (comma-separated)'
        required: false
        default: 'linux/amd64,linux/arm64,linux/arm/v7'

jobs:
  publish:
    name: Build and Publish Docker Image
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: amd64,arm64,arm

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        version: latest

    - name: Normalize repository owner to lowercase
      id: owner
      run: |
        echo "owner=$(echo $GITHUB_REPOSITORY | cut -d'/' -f1 | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
    - name: Normalize repository name to lowercase
      id: repo
      run: |
        echo "repo=$(echo $GITHUB_REPOSITORY | cut -d'/' -f2 | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ steps.owner.outputs.owner }}
        password: ${{ secrets.GITHUB_TOKEN }}
        logout: true

    - name: Update Version String
      env:
        VERSION_TAG: ${{ github.event.inputs.tag }}
      run: |
        if [ "$VERSION_TAG" != "latest" ] && [ "$VERSION_TAG" != "" ]; then
          sed -i -r 's/VERSION = "custom"/VERSION = "'$VERSION_TAG'"/' pydock2date/__init__.py
        else
          sed -i -r 's/VERSION = "custom"/VERSION = "latest"/' pydock2date/__init__.py
        fi
        echo "Version updated to: $VERSION_TAG"

    - name: Debug: show computed image tags
      run: |
        echo "Computed tags:"
        echo "ghcr.io/${{ steps.owner.outputs.owner }}/${{ steps.repo.outputs.repo }}:${{ github.event.inputs.tag }}"

    - name: Build and Push Docker Image
      id: build
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile
        platforms: ${{ github.event.inputs.platforms }}
        push: true
        cache-from: type=gha,scope=main
        cache-to: type=gha,mode=max,scope=main
        tags: |
          ghcr.io/${{ steps.owner.outputs.owner }}/${{ steps.repo.outputs.repo }}:${{ github.event.inputs.tag }}

    - name: Generate artifact attestation
      uses: actions/attest-build-provenance@v1
      with:
        subject-name: ghcr.io/${{ steps.owner.outputs.owner }}/${{ steps.repo.outputs.repo }}:${{ github.event.inputs.tag }}
        subject-digest: ${{ steps.build.outputs.digest }}
        push-to-registry: true

    - name: Notify on Success
      if: success()
      run: |
        echo "‚úÖ Docker image published successfully!"
        echo "üì¶ Available at: ghcr.io/${{ steps.owner.outputs.owner }}/${{ steps.repo.outputs.repo }}:${{ github.event.inputs.tag }}"
        echo "üåê Make sure the package is set to public in GitHub settings"

    - name: Notify on Failure
      if: failure()
      run: |
        echo "‚ùå Docker image publish failed!"
        echo "Check the logs for details."